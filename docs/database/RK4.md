# ДЗ 4 Оптимизация работы СУБД

## Установка Vegeta

```bash
go install github.com/tsenart/vegeta/...@latest
```

## Миграция базы данных

Перед запуском нагрузочного тестирования необходимо убедиться, что база данных содержит необходимые таблицы данные.
Для этого нужно выполнить [миграции](../../migrations/), а также заполнение базы [тестовыми данными](../../testdata/postgres/):

Требуется установка `migrate`, см. [Миграции базы данных](./postgres/migrations.md)

```bash
make all-prepare
```

По ходу миграции создается сущность пользователь, а также сущность рекомендаций для данного пользователя.

## Скрипта для запуска нагрузочного тестирования

Был создан скрипт [scripts/vegeta/vegeta.sh](../../scripts/vegeta/vegeta.sh), который позволяет запускать нагрузочное тестирование с помощью Vegeta. Скрипт поддерживает следующие переменные окружения для настройки:

```bash
vegeta.sh --get-reco [--type movie|series] [--rate N] [--duration 30s] [--timeout 10s]
vegeta.sh --post-signup --users N [--rate N] [--duration 30s] [--timeout 10s]

# также через переменные окружения можно задать:
ENDPOINT=http://localhost:8080
REPORT_DIR=reports
TARGETS_DIR=targets
```

### Запуск скрипта

```bash
cd scripts/vegeta/
# Запрос на получения рекомендаций фильмов с нагрузкой 50 запросов в секунду в течение 30 секунд
ENDPOINT=https://popfilms.ru/api/v1 ./vegeta.sh --get-reco --type movie --rate 50 --duration 30s


# Создание 100_000 пользователей (с нагрузкой 100 запросов в секунду в течение 1000 секунд)
cd scripts/vegeta/
ENDPOINT=https://popfilms.ru/api/v1 ./vegeta.sh --post-signup --users 100000 --rate 100 --duration 1000s

# Создание 100_000 пользователей (с нагрузкой 200 запросов в секунду в течение 500 секунд)
ENDPOINT=https://popfilms.ru/api/v1 ./vegeta.sh --post-signup --users 100000 --rate 200 --duration 500s

# Создание 100_000 пользователей (с нагрузкой 500 запросов в секунду в течение 200 секунд)
ENDPOINT=https://popfilms.ru/api/v1 ./vegeta.sh --post-signup --users 100000 --rate 500 --duration 200s
```

## Результаты

Результаты нагрузочного тестирования сохраняются в директории, указанной в переменной окружения `REPORT_DIR` (по умолчанию [scipts/vegeta/reports](../../scripts/vegeta/reports)). В этой директории находятся файлы с результатами тестов, которые можно анализировать для оценки производительности системы.

### Анализ результатов

Посмотрев на полученные [отчет](../../scripts/vegeta/reports/post_auth_signup_users_100000_20251219_233058.txt) после попытки создать 100000 пользователей на 200 RPS, можно сделать выводы о плохой производительности системы при высоких нагрузках.

В нашем случае при увеличении параметра скрипта --rate (RPS) сервис аутентификации перестает отвечать, выдавая ошибки по типу:

```json
{
  "level": "error",
  "ts": 1766176459.8010926,
  "caller": "auth/callers.go:55",
  "msg": "could not call CreateUser",
  "requestID": "a114b616365a/3P6smBcgla-095217",
  "error": "rpc error: code = DeadlineExceeded desc = context deadline exceeded"
}
```

что свидетельствует о том, что rpc запрос прутхает раньше, чем отвечает база данных.

Можно сделать вывод, что база данных не справляется с нагрузкой и требуется оптимизация.

На мой взгяд, будет достаточно добавить ratelimiting на уровне сервиса аутентификации, чтобы избежать перегрузки сервиса и как следствие базы данных.
